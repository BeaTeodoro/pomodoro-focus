<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="utf-8" />
  <title>Pomodoro Focus · Core Player (invisível)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      background: transparent;
    }

    .notice {
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: #444;
      padding: 12px;
      display: none;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      background: #fff;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <div class="notice" id="notice">
    O player principal está carregado. Se você fechou esta janela, clique para reabrir nas páginas.
    <button id="reopen" class="btn">Reabrir</button>
  </div>

  <script src="https://sdk.scdn.co/spotify-player.js"></script>
  <script>
    // =========================
    // CORE PERSISTENTE GLOBAL
    // =========================
    const chan = new BroadcastChannel('pf-player');
    let player = null;
    let token = null;
    let lastState = null;
    let readyDeviceId = null;
    let isConnecting = false;

    // Ticker de progresso (para updates suaves)
    let tickTimer = null;
    let lastTickMs = 0;

    function getToken() {
      try { return localStorage.getItem('spotify_token'); } catch { return null; }
    }

    function post(type, payload = {}) {
      chan.postMessage({ type, payload });
    }

    // Emite estado atual para as páginas
    function emitState(state) {
      if (!state?.track_window?.current_track) return;
      const t = state.track_window.current_track;
      const current = {
        id: t.id,
        name: t.name,
        artist: (t.artists || []).map(a => a.name).join(', '),
        albumImage: t.album?.images?.[0]?.url || 'img/default-avatar.svg',
        isPlaying: !state.paused,
        position: state.position,
        duration: state.duration
      };
      post('core:state', { current });
    }

    function startTicker() {
      stopTicker();
      lastTickMs = Date.now();
      tickTimer = setInterval(() => {
        if (!lastState) return;
        if (lastState.paused) {
          // parado, só re-emite de vez em quando para manter UI coerente
          emitState(lastState);
          return;
        }
        const now = Date.now();
        const dt = now - lastTickMs;
        lastTickMs = now;

        // avança posição localmente
        lastState.position = Math.min(
          lastState.duration || 0,
          (lastState.position || 0) + dt
        );

        emitState(lastState);
      }, 250);
    }

    function stopTicker() {
      if (tickTimer) {
        clearInterval(tickTimer);
        tickTimer = null;
      }
    }

    window.onSpotifyWebPlaybackSDKReady = async () => {
      await ensurePlayer();
    };

    async function ensurePlayer() {
      if (player || isConnecting) return;
      token = getToken();
      if (!token) {
        post('core:no-token');
        return;
      }
      isConnecting = true;

      if (!window.Spotify) {
        setTimeout(ensurePlayer, 300);
        return;
      }

      player = new Spotify.Player({
        name: 'Pomodoro Focus Player',
        getOAuthToken: cb => cb(token),
        volume: 0.7
      });

      player.addListener('ready', async ({ device_id }) => {
        readyDeviceId = device_id;
        post('core:ready', { device_id });

        // transfere playback para este device
        try {
          await fetch("https://api.spotify.com/v1/me/player", {
            method: "PUT",
            headers: {
              Authorization: `Bearer ${getToken()}`,
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              device_ids: [device_id],
              play: true
            })
          });
        } catch (e) {
          console.warn("Falhou ao transferir playback:", e);
        }
      });

      player.addListener('not_ready', ({ device_id }) => {
        post('core:not-ready', { device_id });
      });

      player.addListener('player_state_changed', (state) => {
        lastState = state;
        // sempre que o SDK emitir, reinicia o ticker para sincronizar
        if (state) {
          emitState(state);
          startTicker();
        } else {
          stopTicker();
        }
      });

      await player.connect();
      isConnecting = false;
    }

    // Controle vindos das páginas
    chan.onmessage = async (ev) => {
      const { type, payload } = ev.data || {};
      if (!type) return;

      if (type === 'core:hello') {
        token = getToken();
        post('core:hello:ack', { hasToken: !!token, device_id: readyDeviceId });
        if (!player) await ensurePlayer();
        if (lastState) emitState(lastState);
        return;
      }

      if (!player) {
        await ensurePlayer();
        if (!player) return;
      }

      try {
        switch (type) {
          case 'ctrl:playpause':
            await player.togglePlay();
            break;
          case 'ctrl:next':
            await player.nextTrack();
            break;
          case 'ctrl:prev':
            await player.previousTrack();
            break;
          case 'ctrl:seek':
            if (typeof payload.ms === 'number') {
              await player.seek(payload.ms);
              // força sincronização local logo após o seek
              if (lastState) {
                lastState.position = payload.ms;
                emitState(lastState);
                startTicker();
              }
            }
            break;
          case 'ctrl:volume':
            if (typeof payload.vol === 'number') await player.setVolume(payload.vol);
            break;
          case 'ctrl:transfer':
            if (readyDeviceId) {
              await fetch('https://api.spotify.com/v1/me/player', {
                method: 'PUT',
                headers: {
                  Authorization: `Bearer ${getToken()}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ device_ids: [readyDeviceId], play: payload?.play ?? false })
              });
            }
            break;
          case 'ctrl:play':
            token = getToken();
            if (!token) return;
            await fetch('https://api.spotify.com/v1/me/player/play', {
              method: 'PUT',
              headers: {
                Authorization: `Bearer ${token}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(payload.body || {})
            });
            break;
          default:
            break;
        }
      } catch (e) {
        post('core:error', { message: e?.message || 'Erro' });
      }
    };

    window.addEventListener('storage', (e) => {
      if (e.key === 'spotify_token' && e.newValue) {
        token = e.newValue;
        ensurePlayer();
      }
    });

    document.getElementById('reopen')?.addEventListener('click', () => {
      window.focus();
    });
  </script>
</body>

</html>